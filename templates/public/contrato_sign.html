{% extends "base_public.html" %}
{% block title %}Assinar Contrato ‚Äî {{ g.tenant.name if g.tenant else "" }}{% endblock %}

{% block content %}
<div class="container py-4">
  <h3 class="mb-1">Contrato de Loca√ß√£o</h3>
  <p class="text-muted">Visualize o contrato e assine dentro da √°rea destacada.</p>

  {# ----------------------------------------------------------------------
     URL do PDF:
     - Se a rota "sign" passou view_url (recomendado), usa direto.
     - Caso contr√°rio, monta a URL para /view com:
         ‚Ä¢ tenant_slug
         ‚Ä¢ reserva_id (de reservation.id OU de reserva_id)
         ‚Ä¢ t = reservation.contract_token (se existir) OU request.args.t (fallback)
     ---------------------------------------------------------------------- #}
  {% set _rid = (reservation.id if reservation is defined else reserva_id) %}
  {% set _tok = (
        (reservation.contract_token if reservation is defined and reservation.contract_token else None)
        or (request.args.get('t') if request is defined else None)
      ) %}
  {% set _view_fallback = url_for('public.view_contract',
                                  tenant_slug=g.tenant.slug,
                                  reserva_id=_rid,
                                  t=_tok) %}
  {% set _view_url = (view_url if view_url is defined and view_url else _view_fallback) %}

  <!-- Visualiza√ß√£o do PDF (sempre exibe o assinado se j√° existir) -->
  <div class="border rounded bg-light p-2 mb-3" style="max-height:65vh; overflow:auto;">
    <iframe
      id="pdf-frame"
      title="Contrato PDF"
      src="{{ _view_url }}#toolbar=0&navpanes=0&view=FitH"
      loading="lazy"
      style="display:block; width:100%; height:62vh; border:0;">
    </iframe>
  </div>

  <!-- √Årea e canvas de assinatura -->
  <div class="text-center mb-2">
    <span class="badge bg-light text-dark border">‚úçÔ∏è Assine dentro da √°rea demarcada</span>
  </div>

  <div id="signature-wrapper" class="position-relative mx-auto" style="max-width:920px;">
    <!-- Slot/guia visual (mesmas propor√ß√µes da assinatura final no PDF) -->
    <div id="sign-slot"
         class="position-absolute start-50 translate-middle-x"
         style="top:18px; width:min(96%, 760px); height:120px; border:2px dashed #0d6efd; border-radius:10px; background:rgba(13,110,253,.05); pointer-events:none; z-index:0;">
    </div>

    <!-- Canvas (desenho) -->
    <canvas id="signature-canvas"
            class="w-100"
            style="display:block; height:156px; background:transparent; cursor:crosshair; position:relative; z-index:1;"></canvas>
  </div>

  <div class="mt-3 d-flex justify-content-center gap-2">
    <button id="clear-signature" type="button" class="btn btn-outline-secondary btn-sm">üßπ Limpar assinatura</button>

    <!-- IMPORTANTE: type="button" e data-post-url apontando para apply_signature -->
    <button
      id="save-signature"
      type="button"
      class="btn btn-success btn-sm"
      data-post-url="{{ url_for('public.apply_signature',
                                tenant_slug=g.tenant.slug,
                                reserva_id=_rid) }}">
      ‚úÖ Confirmar assinatura
    </button>
  </div>

  <div id="sign-error" class="alert alert-danger mt-3 d-none text-center"></div>
</div>
{% endblock %}
