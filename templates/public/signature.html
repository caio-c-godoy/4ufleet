{% extends "base_public.html" %}
{% block title %}Assinar Contrato — {{ g.tenant.name if g.tenant else "" }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h4 class="mb-3">Assinatura do Contrato</h4>
        <p class="text-muted">Assine no espaço abaixo usando o mouse ou o dedo (em dispositivos móveis).</p>

        <!-- Canvas para assinatura -->
        <div class="border rounded mb-3" style="height:300px; position:relative;">
          <canvas id="signature-pad" width="700" height="300"
                  style="width:100%; height:100%;"></canvas>
        </div>

        <!-- Botões -->
        <div class="d-flex gap-2">
          <button id="clear-signature" class="btn btn-outline-secondary">🧹 Limpar</button>
          <button id="save-signature" class="btn btn-success">💾 Salvar assinatura</button>
        </div>

        <div id="status-msg" class="mt-3 small text-muted"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const canvas = document.getElementById("signature-pad");
  const ctx = canvas.getContext("2d");
  let drawing = false;

  function getXY(e) {
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    return {x, y};
  }

  function startDraw(e) {
    drawing = true;
    ctx.beginPath();
    const {x, y} = getXY(e);
    ctx.moveTo(x, y);
  }

  function draw(e) {
    if (!drawing) return;
    e.preventDefault();
    const {x, y} = getXY(e);
    ctx.lineTo(x, y);
    ctx.stroke();
  }

  function stopDraw() {
    drawing = false;
    ctx.closePath();
  }

  // Eventos mouse
  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", stopDraw);
  canvas.addEventListener("mouseleave", stopDraw);

  // Eventos touch
  canvas.addEventListener("touchstart", startDraw);
  canvas.addEventListener("touchmove", draw);
  canvas.addEventListener("touchend", stopDraw);

  // Botão limpar
  document.getElementById("clear-signature").addEventListener("click", function() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    document.getElementById("status-msg").textContent = "Área de assinatura limpa.";
  });

  // Botão salvar
  document.getElementById("save-signature").addEventListener("click", function() {
    const dataURL = canvas.toDataURL("image/png");

    fetch("{{ url_for('public.save_signature', reserva_id=reservation.id, tenant_slug=g.tenant.slug) }}", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ image: dataURL })
    })
    .then(res => res.json())
    .then(data => {
      if (data.ok) {
        document.getElementById("status-msg").textContent = "✅ Assinatura salva com sucesso!";
        document.getElementById("status-msg").classList.add("text-success");
      } else {
        document.getElementById("status-msg").textContent = "❌ Erro ao salvar assinatura.";
        document.getElementById("status-msg").classList.add("text-danger");
      }
    })
    .catch(() => {
      document.getElementById("status-msg").textContent = "❌ Falha na comunicação com o servidor.";
      document.getElementById("status-msg").classList.add("text-danger");
    });
  });
});
</script>
{% endblock %}
