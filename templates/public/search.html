{% extends "base_public.html" %}
{% block title %}Buscar carro — {{ g.tenant.name if g.tenant else "" }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-10">
    <div class="card shadow-sm">
      <div class="card-body">
        <h1 class="h4 mb-3">Encontre o carro ideal</h1>

        <form method="get" action="{{ url_for('public.results', tenant_slug=g.tenant.slug) }}">
          <div class="row g-3">

            <!-- RETIRADA -->
            <div class="col-12 col-lg-6">
              <label class="form-label">Retirada (aeroporto)</label>
              <div class="position-relative" style="max-width:640px;">
                <input
                  id="pickup_airport"
                  name="pickup_airport"
                  type="text"
                  class="form-control"
                  placeholder="Ex: Miami Intl (MIA), Orlando, JFK…"
                  autocomplete="off"
                  required
                />
                <div id="pickup_dd"
                     class="dropdown-menu show"
                     style="width:100%; max-height:200px; overflow-y:auto; display:none; z-index:1050;"></div>
              </div>
            </div>

            <!-- DEVOLUÇÃO -->
            <div class="col-12 col-lg-6">
              <label class="form-label">Devolução (aeroporto)</label>
              <div class="position-relative" style="max-width:640px;">
                <input
                  id="dropoff_airport"
                  name="dropoff_airport"
                  type="text"
                  class="form-control"
                  placeholder="Ex: Miami Intl (MIA), Orlando, JFK…"
                  autocomplete="off"
                  required
                />
                <div id="dropoff_dd"
                     class="dropdown-menu show"
                     style="width:100%; max-height:200px; overflow-y:auto; display:none; z-index:1050;"></div>
              </div>
            </div>

            <div class="col-6 col-lg-3">
              <label class="form-label">Data de retirada</label>
              <input type="date" name="pickup_date" class="form-control" required>
            </div>
            <div class="col-6 col-lg-3">
              <label class="form-label">Hora de retirada</label>
              <input type="time" name="pickup_time" class="form-control" value="10:00" required>
            </div>
            <div class="col-6 col-lg-3">
              <label class="form-label">Data de devolução</label>
              <input type="date" name="dropoff_date" class="form-control" required>
            </div>
            <div class="col-6 col-lg-3">
              <label class="form-label">Hora de devolução</label>
              <input type="time" name="dropoff_time" class="form-control" value="10:00" required>
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label">Nome completo</label>
              <input name="name" class="form-control" placeholder="Seu nome" required>
            </div>

            <!-- Telefone com DDI -->
            <div class="col-12 col-lg-4">
              <label class="form-label">Telefone</label>
              <div class="d-flex gap-2">
                <select name="ddi" id="ddi" class="form-control" style="max-width:120px" required>
                  <option value="1">+1 (US)</option>
                  <option value="55">+55 (BR)</option>
                  <option value="351">+351 (PT)</option>
                  <option value="34">+34 (ES)</option>
                  <option value="44">+44 (UK)</option>
                  <option value="33">+33 (FR)</option>
                </select>
                <input type="tel" id="local_phone" class="form-control" placeholder="(11) 98888-7777" minlength="8" required>
              </div>
              <input type="hidden" name="phone" id="full_phone" value="{{ request.args.get('phone','') }}">
            </div>

            <div class="col-12 col-lg-4">
              <label class="form-label">Email</label>
              <input type="email" name="email" class="form-control" placeholder="voce@exemplo.com" required>
            </div>

            <div class="col-12 d-flex justify-content-end">
              <button class="btn btn-primary px-4">
                <i class="bi bi-search me-2"></i>Ver ofertas
              </button>
            </div>
          </div>

          <!-- JS do DDI/telefone -->
          <script>
            document.addEventListener("DOMContentLoaded", function () {
              const form = document.querySelector("form");
              const ddi = document.getElementById("ddi");
              const local = document.getElementById("local_phone");
              const phoneHidden = document.getElementById("full_phone");
              const email = document.querySelector('input[name="email"]');

              if (phoneHidden && phoneHidden.value && phoneHidden.value.startsWith("+")) {
                const compact = phoneHidden.value.replace(/\s+/g, "");
                const m = compact.match(/^\+(\d{1,3})(.*)$/);
                if (m) {
                  ddi.value = m[1];
                  local.value = m[2].replace(/[^\d]/g, "");
                }
              }

              form.addEventListener("submit", function (e) {
                const digits = (local.value || "").replace(/[^\d]/g, "");
                if (!digits) {
                  e.preventDefault();
                  local.reportValidity();
                  return;
                }
                if (digits.length < 8) {
                  e.preventDefault();
                  local.setCustomValidity("Digite ao menos 8 dígitos do número.");
                  local.reportValidity();
                  setTimeout(() => local.setCustomValidity(""), 2000);
                  return;
                }
                phoneHidden.value = `+${ddi.value}${digits}`;
                if (email && email.value) email.value = email.value.trim().toLowerCase();
              });
            });
          </script>
        </form>
      </div>
    </div>

    <p class="text-muted small mt-3 mb-0">
      Dica: digite o nome do aeroporto ou o código IATA (ex.: <strong>MIA</strong>, <strong>MCO</strong>, <strong>JFK</strong>).
    </p>
  </div>
</div>

<!-- datalist permanece (não atrapalha; útil se quiser manter fallback) -->
<datalist id="us-airports"></datalist>
{% endblock %}

{% block extra_css %}
<style>
  .air-item { padding:.5rem .75rem; cursor:pointer; white-space:normal; }
  .air-item:hover, .air-item.active { background: var(--bs-light); }
  .air-section { font-size:.75rem; color: var(--bs-secondary); padding:.25rem .75rem; text-transform:uppercase; }
</style>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  // Lista vinda do backend. Pode ser [].
  const SERVED = Array.isArray({{ (airports_served|tojson) or '[]' }})
    ? {{ (airports_served|tojson) or '[]' }} : [];

  // normalização para comparar com segurança (case, espaços, hífens tipográficos)
  const norm = (s) => (s || "")
    .toLowerCase()
    .replace(/\s+/g, " ")
    .trim()
    .replace(/[\u2010-\u2015\u2212]/g, "-");

  const servedSet = new Set(SERVED.map(norm));

  const fields = [
    { input: "pickup_airport",  menu: "pickup_dd",  title: "Locais atendidos" },
    { input: "dropoff_airport", menu: "dropoff_dd", title: "Locais atendidos" },
  ];

  function hide(menuEl){ menuEl.style.display = "none"; }

  function renderMenu(menuEl, items, title) {
    menuEl.innerHTML = "";
    if (title) {
      const head = document.createElement("div");
      head.className = "air-section";
      head.textContent = title;
      menuEl.appendChild(head);
    }
    // mostra no máx. 5; resto por rolagem
    const MAX_VISIBLE = 5;
    items.slice(0, MAX_VISIBLE).forEach(txt => {
      const d = document.createElement("div");
      d.className = "dropdown-item air-item";
      d.textContent = txt;
      d.addEventListener("click", () => {
        menuEl.__bindInput.value = txt;
        menuEl.__bindInput.dataset.validServed = "1"; // marca como válido
        hide(menuEl);
      });
      menuEl.appendChild(d);
    });

    menuEl.style.maxHeight = "240px";
    menuEl.style.overflow = "auto";
    menuEl.style.display = items.length ? "block" : "none";
  }

  // filtra SOMENTE dentro dos atendidos (no cliente mesmo)
  function suggestFromServed(q) {
    if (!q) return SERVED.slice();
    const ql = norm(q);
    return SERVED.filter(s => norm(s).includes(ql));
  }

  // wire nos dois campos
  fields.forEach(({input, menu, title}) => {
    const inp = document.getElementById(input);
    const dd  = document.getElementById(menu);
    if (!inp || !dd) return;
    dd.__bindInput = inp;

    // sempre que o valor mudar, reset da “marca de válido”
    inp.addEventListener("input", () => {
      const v = norm(inp.value);
      if (servedSet.has(v)) {
        inp.dataset.validServed = "1";
      } else {
        delete inp.dataset.validServed;
      }
    });

    // focou → mostra a lista do tenant
    inp.addEventListener("focus", () => {
      if (SERVED.length) renderMenu(dd, SERVED, title);
      else hide(dd);
    });

    // digitou → filtra dentro dos atendidos
    let tmr = null;
    inp.addEventListener("input", () => {
      const q = inp.value.trim();
      clearTimeout(tmr);
      tmr = setTimeout(() => {
        const items = suggestFromServed(q);
        renderMenu(dd, items, title);
      }, 120);
    });

    // Enter escolhe o primeiro; Esc fecha
    inp.addEventListener("keydown", (ev) => {
      if (ev.key === "Escape") hide(dd);
      if (ev.key === "Enter" && dd.style.display === "block") {
        const first = dd.querySelector(".air-item");
        if (first) {
          ev.preventDefault();
          inp.value = first.textContent;
          inp.dataset.validServed = "1";
          hide(dd);
        }
      }
    });
  });

  // fechar dropdown ao clicar fora
  document.addEventListener("click", (ev) => {
    fields.forEach(({menu}) => {
      const dd = document.getElementById(menu);
      const inp = dd?.__bindInput;
      if (dd && dd.style.display === "block" && !dd.contains(ev.target) && ev.target !== inp) {
        hide(dd);
      }
    });
  });

  // Travar SUBMIT se valores não forem da lista SERVED
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector('form[action*="/results"]') || document.querySelector("form");
    if (!form) return;

    function ensureValid(inp, label) {
      const v = norm(inp.value);
      const ok = servedSet.has(v);
      if (!ok) {
        // mensagem nativa de validação
        inp.setCustomValidity(`Selecione ${label} a partir da lista de locais atendidos.`);
        inp.reportValidity();
        setTimeout(() => inp.setCustomValidity(""), 2000);
        inp.focus();
      }
      return ok;
    }

    form.addEventListener("submit", (ev) => {
      // se não há lista configurada no tenant, não trava
      if (!SERVED.length) return;

      const pick = document.getElementById("pickup_airport");
      const drop = document.getElementById("dropoff_airport");
      if (pick && !ensureValid(pick, "o local de retirada")) { ev.preventDefault(); return; }
      if (drop && !ensureValid(drop, "o local de devolução")) { ev.preventDefault(); return; }
    });
  });
})();
</script>
{% endblock %}

