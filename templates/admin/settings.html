{% extends "base.html" %}
{% block title %}Configurações · {{ g.tenant.name }}{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h3 class="mb-0">Configurações do Tenant</h3>
  <span class="text-muted small">Slug: <code>{{ g.tenant.slug }}</code></span>
</div>

<ul class="nav nav-pills mb-3" id="settingsTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-branding" data-bs-toggle="tab" data-bs-target="#pane-branding" type="button" role="tab">Branding</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-payments" data-bs-toggle="tab" data-bs-target="#pane-payments" type="button" role="tab">Pagamentos</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-contract" data-bs-toggle="tab" data-bs-target="#pane-contract" type="button" role="tab">Contrato</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-signature" data-bs-toggle="tab" data-bs-target="#pane-signature" type="button" role="tab">Assinatura</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-mail" data-bs-toggle="tab" data-bs-target="#pane-mail" type="button" role="tab">E-mail</button>
  </li>
  
  <li class="nav-item" role="presentation">
  <button class="nav-link" id="tab-i18n" data-bs-toggle="tab" data-bs-target="#pane-i18n" type="button" role="tab">
    Idioma
  </button>
    </li>

  <!-- NOVA ABA: Links & Embed -->
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-links" data-bs-toggle="tab" data-bs-target="#pane-links" type="button" role="tab">Links &amp; Embed</button>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" href="{{ url_for('admin.settings_login_hero', tenant_slug=g.tenant.slug) }}">
      Login (Hero)
    </a>
  </li>
  <li class="nav-item ms-auto" role="presentation">
    <button class="nav-link" id="tab-users" data-bs-toggle="tab" data-bs-target="#pane-users" type="button" role="tab">Usuários</button>
  </li>
</ul>

<div class="tab-content">

  <!-- BRANDING -->
  <div class="tab-pane fade show active" id="pane-branding" role="tabpanel" aria-labelledby="tab-branding">
    <div class="card">
      <div class="card-header">Branding (cores e logotipo)</div>
      <div class="card-body">
        <form action="{{ url_for('admin.settings', tenant_slug=g.tenant.slug) }}" method="post" enctype="multipart/form-data" class="row g-3">
          <input type="hidden" name="_section" value="branding">

          <div class="col-md-6">
            <label class="form-label">Nome da empresa</label>
            <input type="text" name="company_name" class="form-control" value="{{ t.name or '' }}" required>
            <div class="form-text">Aparece no topo, ao lado do logotipo.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Cor primária (botões/links)</label>
            <input type="text" name="brand_primary" class="form-control" placeholder="#0d6efd" value="{{ t.brand_primary or '' }}">
            <div class="form-text">Use formato hex (#RRGGBB). Ex: <code>#0d6efd</code></div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Cor da Navbar (topo)</label>
            <input type="text" name="brand_navbar_bg" class="form-control" placeholder="#0d6efd" value="{{ t.brand_navbar_bg or '' }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Cor da Sidebar (menu lateral)</label>
            <input type="text" name="brand_sidebar_bg" class="form-control" placeholder="#0b5ed7" value="{{ t.brand_sidebar_bg or '' }}">
          </div>

          <div class="col-md-6">
            <label class="form-label">Logotipo (PNG/JPG/WebP/SVG)</label>
            <input type="file" name="logo_file" class="form-control">
            <div class="form-text">Será exibido no lugar de “CAR RENTAL”.</div>
          </div>
          <div class="col-md-6 d-flex align-items-end">
            <div>
              <div class="text-muted small mb-1">Pré-visualização atual:</div>
              {% set _preview = t.brand_logo_url or t.logo_url or t.logo_path %}
              {% if _preview %}
                <img src="{{ _preview | imgsrc }}" alt="Logo" style="max-height:40px">
                <div class="small text-muted mt-1 text-break"><code>{{ _preview }}</code></div>
              {% else %}
                <span class="text-muted">Nenhum logo definido.</span>
              {% endif %}
            </div>
          </div>

          <div class="col-12">
            <button class="btn btn-primary"><i class="bi bi-check2"></i> Salvar branding</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- ========== Airports atendidos (por tenant) ========== -->
<div class="card mt-4">
  <div class="card-header">
    <strong>Locais de atendimento (Aeroportos)</strong>
  </div>
  <div class="card-body">

    <p class="text-muted small mb-2">
      Pesquise pelo aeroporto e clique para adicionar. A lista abaixo define os locais que aparecerão na página pública.
    </p>

    <!-- URLs dos endpoints (renderizadas por Jinja) -->
    <div
      id="airports-config"
      data-get="{{ url_for('admin.admin_get_airports_served', tenant_slug=g.tenant.slug) }}"
      data-post="{{ url_for('admin.admin_set_airports_served', tenant_slug=g.tenant.slug) }}"
      data-suggest="{{ url_for('public.airports_json', tenant_slug=g.tenant.slug) }}">
    </div>

    <!-- input + sugestões -->
    <div class="position-relative" style="max-width: 680px;">
      <input
        id="airport-search"
        type="text"
        class="form-control"
        placeholder="Comece a digitar (ex.: MIA, Orlando, JFK...)"
        autocomplete="off">
      <div id="airport-suggest" class="list-group position-absolute w-100 shadow-sm" style="z-index: 30; max-height: 240px; overflow:auto; display:none;"></div>
    </div>

    <!-- chips -->
    <div id="airport-chips" class="d-flex flex-wrap gap-2 mt-3"></div>

    <!-- ações -->
    <div class="mt-3 d-flex gap-2">
      <button id="btn-save-airports" class="btn btn-primary btn-sm">Salvar locais</button>
      <button id="btn-clear-airports" class="btn btn-outline-secondary btn-sm">Limpar tudo</button>
      <div id="airports-flash" class="ms-2 small"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const root    = document.getElementById('airports-config');
  if (!root) return;

  const GET_URL    = root.dataset.get;
  const POST_URL   = root.dataset.post;
  const SUGGEST_URL= root.dataset.suggest;

  const $input   = document.getElementById('airport-search');
  const $list    = document.getElementById('airport-suggest');
  const $chips   = document.getElementById('airport-chips');
  const $saveBtn = document.getElementById('btn-save-airports');
  const $clearBtn= document.getElementById('btn-clear-airports');
  const $flash   = document.getElementById('airports-flash');

  /** estado local */
  let selected = []; // array de strings exatamente como voltam do /airports.json, ex: "Miami International Airport (MIA) - Miami"

  function flash(msg, type="muted") {
    $flash.className = "ms-2 small text-" + type;
    $flash.textContent = msg || "";
    if (msg) setTimeout(() => { $flash.textContent = ""; }, 4000);
  }

  function renderChips() {
    $chips.innerHTML = "";
    selected.forEach((label, idx) => {
      const chip = document.createElement('span');
      chip.className = "badge rounded-pill bg-secondary";
      chip.style.fontSize = "0.9rem";
      chip.style.display = "inline-flex";
      chip.style.alignItems = "center";
      chip.style.gap = ".4rem";
      chip.textContent = label;

      const x = document.createElement('button');
      x.type = "button";
      x.className = "btn-close btn-close-white btn-sm ms-1";
      x.style.filter = "invert(1)";
      x.ariaLabel = "Remover";
      x.onclick = () => {
        selected.splice(idx, 1);
        renderChips();
      };
      chip.appendChild(x);
      $chips.appendChild(chip);
    });
  }

  function addIfNotExists(label) {
    if (!label) return;
    if (selected.includes(label)) return;
    selected.push(label);
    renderChips();
  }

  function showSuggest(items) {
    if (!items || !items.length) {
      $list.style.display = "none";
      $list.innerHTML = "";
      return;
    }
    $list.innerHTML = "";
    items.slice(0, 20).forEach(txt => {
      const a = document.createElement('button');
      a.type = "button";
      a.className = "list-group-item list-group-item-action";
      a.textContent = txt;
      a.onclick = () => {
        addIfNotExists(txt);
        $input.value = "";
        $list.style.display = "none";
        $list.innerHTML = "";
        $input.focus();
      };
      $list.appendChild(a);
    });
    $list.style.display = "block";
  }

  /** debounce simples */
  let tId = null;
  $input.addEventListener('input', (e) => {
    const q = (e.target.value || "").trim();
    if (tId) clearTimeout(tId);
    if (q.length < 2) {
      $list.style.display = "none";
      $list.innerHTML = "";
      return;
    }
    tId = setTimeout(async () => {
      try {
        const res = await fetch(`${SUGGEST_URL}?q=${encodeURIComponent(q)}`, { credentials: 'same-origin' });
        const data = await res.json();
        showSuggest(data.items || []);
      } catch (err) {
        console.error(err);
        showSuggest([]);
      }
    }, 200);
  });

  document.addEventListener('click', (ev) => {
    if (!$list.contains(ev.target) && ev.target !== $input) {
      $list.style.display = "none";
    }
  });

  /** carregar lista atual do tenant */
  (async () => {
    try {
      const res = await fetch(GET_URL, { credentials: 'same-origin' });
      const data = await res.json();
      selected = Array.isArray(data.items) ? data.items.slice(0, 200) : [];
      renderChips();
    } catch (e) {
      console.error(e);
      selected = [];
      renderChips();
    }
  })();

  /** salvar */
  $saveBtn.addEventListener('click', async () => {
    try {
      const res = await fetch(POST_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ items: selected })
      });
      const data = await res.json();
      if (data.ok) {
        flash(`Salvo! (${data.count} locais)`, "success");
      } else {
        flash("Falha ao salvar.", "danger");
      }
    } catch (e) {
      console.error(e);
      flash("Erro ao salvar.", "danger");
    }
  });

  /** limpar tudo */
  $clearBtn.addEventListener('click', () => {
    selected = [];
    renderChips();
  });
})();
</script>

  <!-- PAYMENTS -->
  <div class="tab-pane fade" id="pane-payments" role="tabpanel" aria-labelledby="tab-payments">
    <div class="card">
      <div class="card-header">Pagamentos (GlobalPay / Payment Link)</div>
      <div class="card-body">
        <form action="{{ url_for('admin.settings', tenant_slug=g.tenant.slug) }}" method="post" class="row g-3" autocomplete="off">
          <input type="hidden" name="_section" value="payments">

          <div class="col-12">
            <div class="alert alert-info small mb-2">
              As credenciais são salvas com segurança no <b>Azure Key Vault</b>. O sistema guarda apenas um <i>alias</i> por tenant.
              Para atualizar, digite novamente os valores abaixo.
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Public Key</label>
            <input type="password" name="public_key" class="form-control" placeholder="Digite a Public Key" autocomplete="new-password">
            <div class="form-text">Nunca exibimos o valor salvo.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Merchant Code</label>
            <input type="password" name="merchant_code" class="form-control" placeholder="Digite o Merchant Code" autocomplete="new-password">
          </div>

          <div class="col-md-6">
            <label class="form-label">Token (opcional)</label>
            <input type="password" name="token" class="form-control" placeholder="Se aplicável" autocomplete="new-password">
          </div>

          <div class="col-md-6">
            <label class="form-label">Endpoint (opcional)</label>
            <input type="text" name="endpoint" class="form-control" value="{{ t.payment_endpoint or '' }}" placeholder="https://api.psp.com/v1">
            <div class="form-text">Se vazio, usamos o endpoint padrão do ambiente.</div>
          </div>

          <div class="col-12 d-flex align-items-center gap-2">
            <button class="btn btn-primary"><i class="bi bi-check2"></i> Salvar no Key Vault</button>
            <a class="btn btn-outline-secondary" href="{{ gp_signup }}" target="_blank" rel="noopener">
              Não tem conta? Criar na GlobalPay
            </a>
          </div>

          <div class="col-12">
            <hr>
            <div class="small text-muted">
              <b>Alias salvo no Key Vault:</b>
              <code>{{ t.payment_secret_id or '—' }}</code>
              {% if t.gp_pub_key or t.gp_merchant_code or t.gp_token %}
                <div class="mt-2 alert alert-warning p-2 small">
                  Aviso: detectamos credenciais <b>legadas</b> no banco (gp_*). Recomenda-se salvar acima para migrar ao Key Vault
                  e, em seguida, remover os dados legados.
                </div>
              {% endif %}
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- CONTRACT -->
  <div class="tab-pane fade" id="pane-contract" role="tabpanel" aria-labelledby="tab-contract">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div>
          <div class="fw-semibold">Template do contrato (modo Word)</div>
          <div class="text-muted small">Edite livremente. Use a paleta para inserir campos dinâmicos.</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span id="contractStatus" class="badge text-bg-secondary">Pronto para editar</span>
        </div>
      </div>

      <div class="card-body">
        <form method="post" action="{{ url_for('admin.settings', tenant_slug=g.tenant.slug) }}">
          <input type="hidden" name="_section" value="contract">

          <!-- Paleta de campos -->
          <div class="mb-2">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
              <div class="small text-muted">Clique para inserir campos dinâmicos:</div>
              <div class="d-flex align-items-center gap-2">
                <input type="search" id="varSearch" class="form-control form-control-sm" placeholder="Buscar campo…" style="width:220px">
                <button type="button" id="btnInsertPageBreak" class="btn btn-outline-secondary btn-sm">Quebra de página</button>
                <button type="button" id="btnResetDefault" class="btn btn-outline-secondary btn-sm">Restaurar modelo padrão</button>
                <button type="button" id="btnPreview" class="btn btn-outline-primary btn-sm">Pré-visualizar</button>
                <button class="btn btn-primary btn-sm">Salvar</button>
              </div>
            </div>
            <div id="varPalette" class="d-flex flex-wrap gap-2 mt-2"></div>
          </div>

          <!-- Editor -->
          <textarea id="contract_template" name="contract_template_html" rows="22" class="form-control"></textarea>

          <div class="form-text mt-2">
            Dica: para exibir o logo use <code>{{ '{{ tenant_logo_rel }}' }}</code> como <code>src</code> da imagem.
            Ex.: <code>&lt;img src="{{ '{{ tenant_logo_rel }}' }}" style="height:42px"&gt;</code>.
            A “Quebra de página” insere um marcador que será respeitado no PDF.
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- SIGNATURE -->
  <div class="tab-pane fade" id="pane-signature" role="tabpanel" aria-labelledby="tab-signature">
    <div class="card">
      <div class="card-header">Assinatura — posição e tamanho</div>
      <div class="card-body">
        <form action="{{ url_for('admin.settings', tenant_slug=g.tenant.slug) }}" method="post" class="row g-3">
          <input type="hidden" name="_section" value="signature">

          <div class="col-md-3">
            <label class="form-label">X relativo (0–1)</label>
            <input type="number" step="0.01" min="0" max="1" name="sign_x_rel" class="form-control" value="{{ t.sign_x_rel if t.sign_x_rel is not none else 0.62 }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Y relativo (0–1)</label>
            <input type="number" step="0.01" min="0" max="1" name="sign_y_rel" class="form-control" value="{{ t.sign_y_rel if t.sign_y_rel is not none else 0.13 }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Largura (pt)</label>
            <input type="number" step="1" min="10" name="sign_w_pt" class="form-control" value="{{ t.sign_w_pt or 200 }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Altura (pt)</label>
            <input type="number" step="1" min="10" name="sign_h_pt" class="form-control" value="{{ t.sign_h_pt or 80 }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">Rubrica — largura (pt)</label>
            <input type="number" step="1" min="10" name="rub_w_pt" class="form-control" value="{{ t.rub_w_pt or 120 }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Rubrica — altura (pt)</label>
            <input type="number" step="1" min="10" name="rub_h_pt" class="form-control" value="{{ t.rub_h_pt or 48 }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Rubrica — margem (pt)</label>
            <input type="number" step="1" min="0" name="rub_margin_pt" class="form-control" value="{{ t.rub_margin_pt or 20 }}">
          </div>
          <div class="col-md-3 d-flex align-items-center">
            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" value="1" name="rubrica_on_last" id="rubLast" {% if t.rubrica_on_last %}checked{% endif %}>
              <label class="form-check-label" for="rubLast">Rubrica também na última página</label>
            </div>
          </div>

          <div class="col-md-3 d-flex align-items-center">
            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" value="1" name="audit_stamp" id="auditStamp" {% if t.audit_stamp %}checked{% endif %}>
              <label class="form-check-label" for="auditStamp">Carimbo de auditoria no rodapé</label>
            </div>
          </div>

          <div class="col-12">
            <button class="btn btn-primary"><i class="bi bi-check2"></i> Salvar assinatura</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MAIL (AGORA DENTRO de .tab-content) -->
  <div class="tab-pane fade" id="pane-mail" role="tabpanel" aria-labelledby="tab-mail">
  <div class="card">
    <div class="card-header">E-mail por tenant (SMTP seguro no Key Vault)</div>
    <div class="card-body">
      <form action="{{ url_for('admin.settings', tenant_slug=g.tenant.slug) }}" method="post" class="row g-3" autocomplete="off">
        <input type="hidden" name="_section" value="mail">

        <div class="col-md-6">
          <label class="form-label">Remetente (Nome)</label>
          <input type="text" name="mail_from_name" class="form-control" value="{{ t.mail_from_name or t.name or '' }}">
        </div>
        <div class="col-md-6">
          <label class="form-label">Remetente (E-mail)</label>
          <input type="email" name="mail_from_email" class="form-control" value="{{ t.mail_from_email or '' }}" placeholder="ex.: reservas@minhalocadora.com">
        </div>

        <div class="col-md-5">
          <label class="form-label">SMTP Host</label>
          <input type="text" name="smtp_host" class="form-control" placeholder="smtp.seuprovedor.com"
                 value="{{ mail_cfg.host if mail_cfg else '' }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Porta</label>
          <input type="number" name="smtp_port" class="form-control" placeholder="587"
                 value="{{ mail_cfg.port if mail_cfg else '' }}">
        </div>
        <div class="col-md-2 d-flex align-items-center">
          <div class="form-check mt-4">
            <input class="form-check-input" type="checkbox" name="smtp_tls" id="smtpTLS"
                   {% if not mail_cfg or mail_cfg.use_tls %}checked{% endif %}>
            <label class="form-check-label" for="smtpTLS">TLS</label>
          </div>
        </div>
        <div class="col-md-2 d-flex align-items-center">
          <div class="form-check mt-4">
            <input class="form-check-input" type="checkbox" name="smtp_ssl" id="smtpSSL"
                   {% if mail_cfg and mail_cfg.use_ssl %}checked{% endif %}>
            <label class="form-check-label" for="smtpSSL">SSL</label>
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Usuário</label>
          <input type="text" name="smtp_user" class="form-control" placeholder="usuario"
                 value="{{ mail_cfg.user if mail_cfg else '' }}" autocomplete="off">
        </div>
        <div class="col-md-6">
          <label class="form-label">Senha</label>
          <input type="password" name="smtp_pass" class="form-control" placeholder="senha" autocomplete="new-password">
          <div class="form-text">As credenciais ficam guardadas no Key Vault. O sistema armazena apenas o alias.</div>
        </div>

        <div class="col-12 d-flex align-items-center flex-wrap gap-2">
          <button class="btn btn-primary">
            <i class="bi bi-check2"></i> Salvar e-mail no Key Vault
          </button>

          <!-- NOVO: campo "Para (teste)" -->
          <div class="input-group" style="max-width:460px">
            <span class="input-group-text">Para (teste)</span>
            <input type="email" id="mailTestTo" class="form-control"
                   value="{{ current_user.email or t.mail_from_email or '' }}"
                   placeholder="email que receberá o teste">
            <button type="button" class="btn btn-outline-secondary" id="btnMailTest"
                    data-url="{{ url_for('admin.mail_test', tenant_slug=g.tenant.slug) }}">
              Enviar e-mail de teste
            </button>
          </div>

          {% if t.mail_secret_id %}
            <span class="badge text-bg-light">Alias: <code>{{ t.mail_secret_id }}</code></span>
          {% else %}
            <span class="text-muted small">Nenhum alias salvo para este tenant.</span>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
</div>

    <!-- LINKS & EMBED -->
  <div class="tab-pane fade" id="pane-links" role="tabpanel" aria-labelledby="tab-links">
    <div class="card">
      <div class="card-header">Links do Tenant &amp; Código de Incorporação</div>
      <div class="card-body">
        {% set public_url = url_for('public.search', tenant_slug=g.tenant.slug, _external=True) %}
        {% set checklist_url = url_for('admin.operator_checklists_index', tenant_slug=g.tenant.slug, stage='entrega', _external=True) %}

        <div class="mb-3">
          <label class="form-label">URL Pública (Pesquisa → Checkout)</label>
          <div class="input-group">
            <input type="text" class="form-control" id="publicUrl" value="{{ public_url }}" readonly>
            <button class="btn btn-outline-secondary" type="button" data-copy="#publicUrl">Copiar</button>
            <a class="btn btn-outline-primary" href="{{ public_url }}" target="_blank" rel="noopener">Abrir</a>
          </div>
          <div class="form-text">Use este link no seu site ou redes sociais para receber reservas diretamente.</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Código para incorporar no site (iframe)</label>
          <textarea id="embedCode" class="form-control" rows="3" readonly><iframe src="{{ public_url }}" width="100%" height="900" style="border:0;" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></textarea>
          <div class="mt-2">
            <button class="btn btn-outline-secondary btn-sm" type="button" data-copy="#embedCode">Copiar iframe</button>
          </div>
          <div class="form-text">Cole este código em uma página do seu site para exibir a busca e o checkout dentro do seu domínio.</div>
        </div>

        <hr>

        <div class="mb-3">
          <label class="form-label">Checklist do Operador (Entrega)</label>
          <div class="input-group">
            <input type="text" class="form-control" id="checklistUrl" value="{{ checklist_url }}" readonly>
            <button class="btn btn-outline-secondary" type="button" data-copy="#checklistUrl">Copiar</button>
            <a class="btn btn-outline-primary" href="{{ checklist_url }}" target="_blank" rel="noopener">Abrir</a>
          </div>
          <div class="form-text">Compartilhe com a equipe de operação. <b>Requer login</b>.</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Checklist (iframe)</label>
          <textarea id="checklistEmbed" class="form-control" rows="3" readonly><iframe src="{{ checklist_url }}" width="100%" height="900" style="border:0;" loading="lazy"></iframe></textarea>
          <div class="mt-2">
            <button class="btn btn-outline-secondary btn-sm" type="button" data-copy="#checklistEmbed">Copiar iframe</button>
          </div>
          <div class="form-text">
            Útil apenas se o site onde será embutido tiver sessão autenticada compartilhada/SSO. Caso contrário, prefira o link direto acima.
          </div>
        </div>

      </div>
    </div>
  </div>



  <!-- USERS -->
<div class="tab-pane fade" id="pane-users" role="tabpanel" aria-labelledby="tab-users">
  <div class="row g-3">
    <div class="col-lg-5">
      <div class="card h-100">
        <div class="card-header">Novo usuário</div>
        <div class="card-body">
          <form action="{{ url_for('admin.settings', tenant_slug=g.tenant.slug) }}" method="post" class="row g-3">
            <input type="hidden" name="_section" value="user_new">
            <div class="col-12">
              <label class="form-label">E-mail</label>
              <input type="email" name="email" class="form-control" required>
            </div>
            <div class="col-12">
              <label class="form-label">Senha</label>
              <input type="password" name="password" class="form-control" required>
            </div>

            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="is_admin" id="isAdmin">
                <label class="form-check-label" for="isAdmin">Administrador (acesso total)</label>
              </div>
              <div class="form-text">
                Dica: se marcar “Administrador”, as permissões abaixo são ignoradas.
              </div>
            </div>

            <!-- MATRIZ DE PERMISSÕES POR MÓDULO -->
            <div class="col-12">
              <div class="d-flex align-items-center justify-content-between">
                <label class="form-label mb-0">Permissões por módulo</label>
                <button class="btn btn-sm btn-outline-secondary" type="button" id="btnPermClear">Limpar tudo</button>
              </div>

              <div class="table-responsive mt-2">
                <table class="table table-sm align-middle">
                  <thead class="table-light">
                    <tr>
                      <th style="min-width:180px">Módulo</th>
                      <th class="text-center">
                        Ver<br>
                        <input type="checkbox" class="form-check-input perm-col" data-col="view" title="Marcar coluna 'Ver'">
                      </th>
                      <th class="text-center">
                        Criar<br>
                        <input type="checkbox" class="form-check-input perm-col" data-col="create" title="Marcar coluna 'Criar'">
                      </th>
                      <th class="text-center">
                        Editar<br>
                        <input type="checkbox" class="form-check-input perm-col" data-col="edit" title="Marcar coluna 'Editar'">
                      </th>
                      <th class="text-center">
                        Excluir<br>
                        <input type="checkbox" class="form-check-input perm-col" data-col="delete" title="Marcar coluna 'Excluir'">
                      </th>
                      <th class="text-center">
                        Cancelar<br>
                        <input type="checkbox" class="form-check-input perm-col" data-col="cancel" title="Marcar coluna 'Cancelar'">
                      </th>
                      <th class="text-center">
                        Enviar link pgto<br>
                        <input type="checkbox" class="form-check-input perm-col" data-col="send_payment" title="Marcar coluna 'Enviar link'">
                      </th>
                      <th class="text-center">
                        Exportar<br>
                        <input type="checkbox" class="form-check-input perm-col" data-col="export" title="Marcar coluna 'Exportar'">
                      </th>
                      <th class="text-center">
                        Tudo<br>
                        <input type="checkbox" class="form-check-input perm-col" data-col="all" title="Marcar todas colunas">
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {% set modules = [
                      ('vehicles', 'Veículos'),
                      ('categories', 'Categorias'),
                      ('rates', 'Tarifas'),
                      ('reservations', 'Reservas'),
                      ('payments', 'Pagamentos'),
                      ('contracts', 'Contratos'),
                      ('checklists', 'Checklists'),
                      ('users', 'Usuários')
                    ] %}
                    {% for key,label in modules %}
                      <tr data-module="{{ key }}">
                        <td class="fw-semibold">
                          {{ label }}
                          <div class="small text-muted">({{ key }})</div>
                        </td>
                        {% for action in ['view','create','edit','delete','cancel','send_payment','export'] %}
                          <td class="text-center">
                            <input
                              type="checkbox"
                              class="form-check-input perm-cell"
                              name="perms[{{ key }}][{{ action }}]"
                              value="1"
                              data-action="{{ action }}"
                            >
                          </td>
                        {% endfor %}
                        <td class="text-center">
                          <input type="checkbox" class="form-check-input perm-row-all" title="Marcar todas as ações deste módulo">
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div class="form-text">
                As permissões definidas aqui serão salvas no cadastro do usuário (escopo deste tenant).
              </div>
            </div>

            <div class="col-12">
  <button class="btn btn-primary">
    <i class="bi bi-person-plus"></i> Criar usuário
  </button>
</div>
</form>
</div>
</div>
</div>

<div class="col-lg-7">
  <div class="card h-100">
    <div class="card-header">Usuários da empresa</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>E-mail</th>
              <th class="text-center">Admin</th>
              <th class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
              <tr>
                <td class="align-middle">{{ u.email }}</td>
                <td class="text-center align-middle">
                  {% if u.is_admin %}
                    <span class="badge text-bg-success">Sim</span>
                  {% else %}
                    <span class="badge text-bg-secondary">Não</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <!-- Permissões -->
                  <button
                    class="btn btn-sm btn-outline-primary me-1"
                    data-bs-toggle="modal"
                    data-bs-target="#editPermsModal"
                    data-user-id="{{ u.id }}"
                    data-user-email="{{ u.email }}"
                    title="Editar permissões"
                  >
                    <i class="bi bi-shield-lock"></i> Permissões
                  </button>
<!-- ATIVAR (aparece sempre; backend trata os campos existentes) -->
<form action="{{ url_for('admin.user_activate') }}"
      method="post"
      class="d-inline"
      onsubmit="return confirm('Ativar/confirmar o usuário {{ u.email }}?');">
  <input type="hidden" name="user_id" value="{{ u.id }}">
  <button type="submit"
          class="btn btn-sm btn-outline-success me-1"
          title="Ativar usuário (marcar como confirmado)">
    <i class="bi bi-check2-circle"></i>
  </button>
</form>

                  <!-- Excluir (não permite excluir a si mesmo; proteção extra no backend impede último admin) -->
                  <form action="{{ url_for('admin.user_delete') }}"
                        method="post"
                        class="d-inline"
                        onsubmit="return confirm('Excluir o usuário {{ u.email }}? Esta ação não pode ser desfeita.');">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    {% if u.id != current_user.id %}
                      <button type="submit"
                              class="btn btn-sm btn-outline-danger"
                              title="Excluir usuário">
                        <i class="bi bi-trash"></i>
                      </button>
                    {% else %}
                      <!-- opcional: mostrar um botão desabilitado para indicar que é você -->
                      <button type="button"
                              class="btn btn-sm btn-outline-danger"
                              title="Você não pode excluir a si mesmo"
                              disabled>
                        <i class="bi bi-trash"></i>
                      </button>
                    {% endif %}
                  </form>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="3" class="text-muted p-3">Nenhum usuário cadastrado.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

</div>


  <!-- Modal (placeholder) para edição — conteúdo dinâmico por fetch -->
  <div class="modal fade" id="editPermsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">Permissões do usuário</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="editPermsBody">
          <div class="text-center text-muted py-5">Carregando…</div>
        </div>
      </div>
    </div>
  </div>
</div>

</div> <!-- /tab-content -->

<hr class="my-4">
<div class="small text-muted">
  Dica: após salvar cores/branding, recarregue a página para ver os novos estilos aplicados no topo e na lateral.
</div>

<!-- Modal de prévia -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Pré-visualização do contrato</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="height:70vh">
        <iframe id="previewFrame" style="width:100%;height:100%;border:0"></iframe>
      </div>
    </div>
  </div>
</div>
{% endblock %}  {# /content #}

{% block extra_js %}
<style>
  #varPalette { position: relative; z-index: 4; }
  .tox-editor-header { position: sticky; top: 0; z-index: 3; }
  #contract_template { margin-top: 8px; }
  .tox-promotion,
  .tox-statusbar__help,
  .tox-notification,
  .tox-notifications-container { display: none !important; }
</style>

<!-- TinyMCE local -->
<script src="{{ url_for('static', filename='vendor/tinymce/tinymce.min.js') }}"></script>

<script>
  /* URLs do backend */
  const CONTRACT_PREVIEW_URL  = "{{ url_for('admin.contract_preview',  tenant_slug=g.tenant.slug) }}";
  const CONTRACT_VALIDATE_URL = "{{ url_for('admin.contract_validate', tenant_slug=g.tenant.slug) }}";
  const TINYMCE_BASE_URL      = "{{ url_for('static', filename='vendor/tinymce') }}";

  /* Conteúdo inicial do contrato vindo do backend, serializado como string JSON */
  const INIT_CONTENT = {{ (g.tenant.contract_template_html or '') | tojson }};

  /* Helpers para tokens de template somente no browser */
  const OPEN  = String.fromCharCode(123,123);
  const CLOSE = String.fromCharCode(125,125);
  const jv = (expr) => `${OPEN} ${expr} ${CLOSE}`;

  /* Paleta de campos */
  const VARS = [
    ["tenant_name","Nome da locadora"],
    ["cliente_nome","Nome do cliente"],
    ["cliente_doc","Drive/CNH"],
    ["cliente_pais","País do cliente"],
    ["voo_numero","Número do voo"],
    ["data_inicio","Data de retirada"],
    ["data_fim","Data de devolução"],
    ["valor_total","Valor total"],
    ["carro_marca","Marca do carro"],
    ["carro_modelo","Modelo do carro"],
    ["carro_ano","Ano do carro"],
    ["carro_cor","Cor do carro"]
  ];

  function buildPalette() {
    const host = document.getElementById('varPalette');
    if (!host) return;
    host.innerHTML = '';
    VARS.forEach(([key,label]) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'btn btn-sm btn-outline-secondary var-chip';
      b.textContent = label;
      b.addEventListener('click', () => tinymce.activeEditor?.insertContent(jv(key)));
      host.appendChild(b);
    });

    const moneyBtn = document.createElement('button');
    moneyBtn.type = 'button';
    moneyBtn.className = 'btn btn-sm btn-outline-secondary';
    moneyBtn.textContent = 'Valor Total';
    moneyBtn.onclick = () => tinymce.activeEditor?.insertContent(jv('valor_total|money(currency)'));
    host.appendChild(moneyBtn);

    const datePairBtn = document.createElement('button');
    datePairBtn.type = 'button';
    datePairBtn.className = 'btn btn-sm btn-outline-secondary';
    datePairBtn.textContent = 'Período (datefmt)';
    datePairBtn.onclick = () => {
      tinymce.activeEditor?.insertContent(jv('data_inicio|datefmt') + ' a ' + jv('data_fim|datefmt'));
    };
    host.appendChild(datePairBtn);

    const todayLongBtn = document.createElement('button');
    todayLongBtn.type = 'button';
    todayLongBtn.className = 'btn btn-sm btn-outline-secondary';
    todayLongBtn.textContent = 'Hoje (por extenso PT-BR)';
    todayLongBtn.onclick = () => tinymce.activeEditor?.insertContent(jv('hoje|datefmt_long_pt'));
    host.appendChild(todayLongBtn);
  }

  function wireVarSearch() {
    const inp = document.getElementById('varSearch');
    if (!inp) return;
    inp.addEventListener('input', () => {
      const q = inp.value.trim().toLowerCase();
      document.querySelectorAll('#varPalette .var-chip').forEach(btn => {
        const txt = (btn.textContent || '').toLowerCase();
        btn.style.display = (!q || txt.includes(q)) ? '' : 'none';
      });
    });
  }

  /* TinyMCE */
  tinymce.init({
    selector: '#contract_template',
    base_url: TINYMCE_BASE_URL,
    suffix: '.min',
    height: 600,
    menubar: 'file edit view format table help',
    statusbar: true,
    plugins: 'lists link image charmap code fullscreen pagebreak preview table',
    toolbar: [
      'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | forecolor backcolor removeformat',
      '| alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | table link image | pagebreak preview fullscreen'
    ].join(' '),
    font_family_formats:
      'Inter=Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;'+
      'Arial=arial,helvetica,sans-serif;'+
      'Times New Roman=times new roman,times,serif;'+
      'Georgia=georgia,palatino,serif;'+
      'Courier New=courier new,courier,monospace',
    fontsize_formats: '10px 11px 12px 13px 14px 16px 18px 20px 22px 24px 28px 32px',
    content_style: `
      @page { size: A4; margin: 18mm 16mm; }
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size: 12px; line-height: 1.5; color:#111; }
      .page-break { page-break-before: always; }
      .box { border:1px solid #ddd; border-radius:6px; padding:10px 12px; }
      h1 { font-size:20px; text-align:center; letter-spacing:.5px; }
      h2 { font-size:14px; margin-top:18px; }
      .small { font-size:11px; color:#666; }
      .sign-hint { height:110px; }
      table { border-collapse: collapse; width: 100%; }
      table, th, td { border: 1px solid #ccc; }
      th, td { padding: 6px 8px; }
      img { max-width: 100%; }
    `,
    convert_urls: false,
    branding: false,
    promotion: false,
    license_key: 'gpl',
    readonly: false,
    toolbar_sticky: true,
    browser_spellcheck: true,
    contextmenu: false,
    setup(editor) {
      editor.on('init', () => {
        try { editor.setMode('design'); } catch(e) {}
        if (INIT_CONTENT) editor.setContent(INIT_CONTENT);
        editor.getWin()?.focus?.();
      });
      const form = editor.formElement || document.querySelector('form[action*="admin/settings"]');
      if (form) form.addEventListener('submit', () => tinymce.triggerSave());
    }
  });

  /* Botões do contrato */
  document.addEventListener('DOMContentLoaded', () => {
    buildPalette();
    wireVarSearch();

    document.getElementById('btnInsertPageBreak')?.addEventListener('click', () => {
      tinymce.activeEditor?.insertContent('<div class="page-break"></div>');
    });

    document.getElementById('btnInsertLogo')?.addEventListener('click', () => {
      tinymce.activeEditor?.insertContent(`<img src="${jv('tenant_logo_rel')}" style="height:42px" alt="Logo">`);
    });

    document.getElementById('btnResetDefault')?.addEventListener('click', () => {
      if (!confirm('Deseja substituir o conteúdo atual pelo modelo padrão?')) return;
      const DEFAULT_TEMPLATE =
`<!DOCTYPE html>
<html><head><meta charset="utf-8">
<style>
  @page { size: A4; margin: 18mm 16mm; }
  body { font-family: -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size: 12px; color:#111; line-height: 1.45; }
  .header { display:flex; align-items:center; gap:12px; margin-bottom: 10px; }
  .logo { height: 42px; }
  h1 { font-size: 20px; margin: 10px 0 12px; text-align:center; letter-spacing:.5px; }
  h2 { font-size: 14px; margin: 18px 0 8px; }
  .small { font-size: 11px; color:#666; }
  .box { border:1px solid #ddd; border-radius:6px; padding:10px 12px; }
  .page-break { page-break-before: always; }
  .sign-hint { height:110px; }
</style></head>
<body>
<div class="header">
  <img class="logo" src="${jv('tenant_logo_rel')}" alt="Logo">
  <div><div style="font-weight:700">${jv('tenant_name')}</div><div class="small">${jv('currency')}</div></div>
</div>
<h1>Contrato de Locação de Veículo</h1>
<div class="box">
  <p><b>Locatário:</b> ${jv('cliente_nome')} — <b>Doc:</b> ${jv('cliente_doc')}</p>
  <p><b>Período:</b> ${jv('data_inicio|datefmt')} a ${jv('data_fim|datefmt')} — 
     <b>Total:</b> ${jv('valor_total|money(currency)')}</p>
  <p><b>Veículo:</b> ${jv('carro_marca')} ${jv('carro_modelo')} ${jv('carro_ano')} (${jv('carro_cor')})</p>
</div>
<h2>Cláusulas</h2>
<p>Edite este texto como desejar. Use os botões acima para inserir campos dinâmicos.</p>
<div class="page-break"></div>
<h2>Assinaturas</h2>
<p class="small">A assinatura digital será aplicada aqui na geração do PDF.</p>
<div class="sign-hint"></div>
<p class="small">Emitido em ${jv('hoje|datefmt_long_pt')}.</p>
</body></html>`;
      tinymce.activeEditor?.setContent(DEFAULT_TEMPLATE);
    });

    document.getElementById('btnPreview')?.addEventListener('click', async () => {
      tinymce.triggerSave();
      const html = document.getElementById('contract_template').value || '';
      try {
        const val = await fetch(CONTRACT_VALIDATE_URL, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ html })
        }).then(r => r.json());
        if (val?.unknown?.length) {
          alert("Atenção: encontramos campos desconhecidos: " + val.unknown.join(', '));
        }
      } catch (e) { console.warn('Falha ao validar', e); }

      try {
        const res = await fetch(CONTRACT_PREVIEW_URL, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ html })
        });
        const markup = await res.text();
        const frame = document.getElementById('previewFrame');
        frame.srcdoc = markup;
        new bootstrap.Modal(document.getElementById('previewModal')).show();
      } catch (e) { alert('Não foi possível gerar a pré-visualização agora.'); }
    });
  });

  /* Utilitário de copiar (Links & Embed) */
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-copy]').forEach(btn => {
      btn.addEventListener('click', () => {
        const sel = document.querySelector(btn.getAttribute('data-copy'));
        if (!sel) return;
        if (sel.select) sel.select();
        const text = sel.value || sel.textContent || '';
        navigator.clipboard.writeText(text).then(() => {
          const old = btn.textContent;
          btn.textContent = 'Copiado!';
          setTimeout(()=> btn.textContent = old || 'Copiar', 1200);
        });
      });
    });
  });

  /* =============================== */
  /*   PERMISSÕES POR MÓDULO - JS    */
  /* =============================== */

  // helper: intercepta submit do form do modal e salva via fetch
  function bindUserPermsForm(container) {
    const form = container.querySelector('#userPermsForm');
    if (!form) return;
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const fd = new FormData(form);
      try {
        const res = await fetch(form.action, { method: 'POST', body: fd });
        const data = await res.json();
        if (data.ok) {
          form.insertAdjacentHTML('beforebegin',
            '<div class="alert alert-success py-2">Permissões salvas.</div>');
          setTimeout(() => {
            const modalEl = document.getElementById('editPermsModal');
            if (modalEl) bootstrap.Modal.getInstance(modalEl)?.hide();
          }, 600);
        } else {
          form.insertAdjacentHTML('beforebegin',
            '<div class="alert alert-danger py-2">Erro: ' + (data.error || 'Falha ao salvar') + '</div>');
        }
      } catch {
        form.insertAdjacentHTML('beforebegin',
          '<div class="alert alert-danger py-2">Não foi possível salvar agora.</div>');
      }
    });
  }

  // Marcar coluna inteira (inclui um "all" que marca todas as colunas)
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.perm-col').forEach(colChk => {
      colChk.addEventListener('change', e => {
        const col = e.target.dataset.col;
        const checked = e.target.checked;

        if (col === 'all') {
          const cols = ['view','create','edit','delete','cancel','send_payment','export'];
          cols.forEach(c => {
            document.querySelectorAll(`tbody input.perm-cell[data-action="${c}"]`)
              .forEach(cb => { cb.checked = checked; });
          });
          document.querySelectorAll('.perm-row-all').forEach(cb => { cb.checked = checked; });
          document.querySelectorAll('.perm-col').forEach(cb => { if (cb.dataset.col !== 'all') cb.checked = checked; });
          return;
        }

        document.querySelectorAll(`tbody input.perm-cell[data-action="${col}"]`)
          .forEach(cb => { cb.checked = checked; });
      });
    });

    // Marcar linha inteira (por módulo) e sincronizar o select-all da linha
    document.querySelectorAll('tbody tr[data-module]').forEach(tr => {
      const rowAll = tr.querySelector('.perm-row-all');
      const cells = tr.querySelectorAll('.perm-cell');
      if (rowAll) {
        rowAll.addEventListener('change', () => {
          cells.forEach(cb => { cb.checked = rowAll.checked; });
        });
      }
      cells.forEach(cb => {
        cb.addEventListener('change', () => {
          const allChecked = Array.from(cells).every(x => x.checked);
          if (rowAll) rowAll.checked = allChecked;
        });
      });
    });

    // Limpar tudo
    const btnClear = document.getElementById('btnPermClear');
    if (btnClear) {
      btnClear.addEventListener('click', () => {
        document.querySelectorAll('.perm-cell, .perm-row-all, .perm-col').forEach(cb => { cb.checked = false; });
      });
    }

    // Modal de edição de permissões (carrega HTML e faz bind do form)
    const editPermsModal = document.getElementById('editPermsModal');
    if (editPermsModal) {
      editPermsModal.addEventListener('show.bs.modal', (ev) => {
        const btn = ev.relatedTarget;
        const uid = btn?.getAttribute('data-user-id');
        const email = btn?.getAttribute('data-user-email') || '';
        const body = editPermsModal.querySelector('#editPermsBody');

        body.innerHTML = `<div class="text-center text-muted py-5">Carregando permissões de <b>${email}</b>…</div>`;

        const url = "{{ url_for('admin.user_perms_modal') }}?user_id=" + encodeURIComponent(uid);
        fetch(url)
          .then(r => r.text())
          .then(html => { body.innerHTML = html; bindUserPermsForm(body); })
          .catch(() => { body.innerHTML = '<div class="text-danger">Falha ao carregar.</div>'; });
      });
    }
  });
</script>
<script>
(function () {
  const btn = document.getElementById("btnMailTest");
  if (!btn) return;

  const getCsrf = () =>
    (document.querySelector("meta[name=csrf-token]")?.content) ||
    (document.querySelector("input[name=csrf_token]")?.value) || "";

  btn.addEventListener("click", async () => {
    const toInput = document.getElementById("mailTestTo");
    const to = (toInput?.value || "").trim();
    if (!to) { alert("Informe um e-mail para o teste."); toInput?.focus(); return; }

    const url = btn.dataset.url;              // /<tenant>/admin/settings/mail.test
    const old = btn.innerHTML;
    btn.disabled = true; btn.innerHTML = "Enviando…";

    try {
      const r = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCsrf(),           // Flask-WTF
          "X-CSRF-Token": getCsrf(),
        },
        credentials: "same-origin",
        body: JSON.stringify({ to }),
      });
      const data = await r.json().catch(() => ({}));
      if (r.ok && data.ok) {
        alert(data.message || "E-mail de teste enviado!");
      } else {
        alert(data.error || `Falha (${r.status}). Veja o console/Network.`);
        console.error("mail.test resp:", r.status, data);
      }
    } catch (e) {
      alert("Erro de rede ao enviar o e-mail de teste.");
      console.error(e);
    } finally {
      btn.disabled = false; btn.innerHTML = old;
    }
  });
})();
</script>

{% endblock %}
