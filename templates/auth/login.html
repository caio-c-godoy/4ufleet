{# templates/auth/login.html #}
{% extends "base.html" %}
{% set hide_chrome = true %}

{% block title %}Entrar ‚Äî {{ tenant.name if tenant else 'Car Rental' }}{% endblock %}

{% block extra_head %}
<style>
  .auth-wrap { min-height:100vh; display:grid; grid-template-columns:520px 1fr; }
  .auth-left { display:flex; align-items:center; justify-content:center; padding:48px 40px; background:#fff; }
  .auth-card { width:100%; max-width:440px; }
  .brand-login { display:flex; align-items:center; gap:12px; margin-bottom:18px; }
  .brand-login img { height:44px; width:auto; object-fit:contain; }
  .brand-login .brand-name { font-weight:700; font-size:1.1rem; letter-spacing:.02em; }
  .muted { color:#6c757d; }
  .forgot a { text-decoration:none; }
  .forgot a:hover { text-decoration:underline; }
  .btn-login { height:46px; font-weight:600; background-color:var(--brand-primary)!important; border-color:var(--brand-primary)!important; }

  .auth-right { position:relative; overflow:hidden; background:#0b1e3a; }
  .hero-bg { position:absolute; inset:0; background-size:cover; background-position:center; filter:saturate(1.05) contrast(1.02); opacity:.9; }
  .hero-overlay{ position:absolute; inset:0; background:linear-gradient(120deg, rgba(0,0,0,.45) 0%, color-mix(in srgb, var(--brand-primary) 35%, transparent) 40%, rgba(0,0,0,.35) 100%); }
  .hero-copy{ position:relative; z-index:1; height:100%; color:#f1f5f9; display:grid; place-items:center; padding:48px; text-shadow:0 1px 12px rgba(0,0,0,.35); }
  .hero-box{ max-width:720px; backdrop-filter:blur(2px); }
  .hero-kicker{ text-transform:uppercase; letter-spacing:.18em; font-size:.78rem; opacity:.85; }
  .hero-title{ font-weight:800; line-height:1.12; margin:.4rem 0 1rem; font-size:clamp(1.6rem,2.2vw + 1rem,2.6rem); }
  .hero-desc{ opacity:.92; font-size:clamp(.98rem,.6vw + .7rem,1.05rem); }

  @media (max-width: 991.98px){
    .auth-wrap{ grid-template-columns:1fr; }
    .auth-right{ display:none; }
    .auth-left{ padding:36px 24px; }
  }
</style>
{% endblock %}

{% block content %}
{% set show_hero = tenant.login_hero_enabled if tenant and tenant.login_hero_enabled is not none else true %}

{# HERO IMG #}
{% set hero_img = tenant.login_hero_image if tenant and tenant.login_hero_image else None %}
{% if hero_img %}
  {% if hero_img.startswith('http') %}
    {% set hero_url = hero_img %}
  {% elif hero_img.startswith('/static/') %}
    {% set hero_url = hero_img %}
  {% else %}
    {% set hero_url = url_for('static', filename=hero_img.lstrip('/')) %}
  {% endif %}
{% endif %}

{# TEXTOS HERO #}
{% set hero_kicker = tenant.login_hero_kicker if tenant and tenant.login_hero_kicker else '4UFLEET ‚Ä¢ MULTIFROTA' %}
{% set hero_title  = tenant.login_hero_title  if tenant and tenant.login_hero_title  else 'Carros, motos, vans, barcos e mais ‚Äî tudo pronto para alugar.' %}
{% set hero_desc   = tenant.login_hero_desc   if tenant and tenant.login_hero_desc   else 'Centralize reservas, tarifas e manuten√ß√£o em um √∫nico painel. Aumente a ocupa√ß√£o da sua frota com automa√ß√µes e relat√≥rios em tempo real.' %}

<div class="auth-wrap" style="{% if not show_hero %}grid-template-columns:1fr;{% endif %}">
  <section class="auth-left">
    <div class="auth-card">
      <div class="brand-login">
        {% set _logo = tenant.logo_url or tenant.brand_logo_url or tenant.logo_path %}
        {% if _logo %}
          {% if _logo.startswith('http') %}
            {% set logo_url = _logo %}
          {% elif _logo.startswith('/static/') %}
            {% set logo_url = _logo %}
          {% else %}
            {% set logo_url = url_for('static', filename=_logo.lstrip('/')) %}
          {% endif %}
          <img src="{{ logo_url }}" alt="{{ tenant.name or 'Logo' }}">
        {% else %}
          <img src="{{ url_for('static', filename='img/4ufleet-logo.png') }}" alt="Logo">
        {% endif %}
        <span class="brand-name">{{ tenant.name if tenant else 'Car Rental' }}</span>
      </div>

      <h3 class="mb-2">Entrar</h3>
      <p class="muted mb-4">Acesse o painel da sua locadora para gerenciar reservas, frota e tarifas.</p>

      <form method="post" action="{{ url_for('auth.login', tenant_slug=tenant.slug) }}">
        {{ form.hidden_tag() if form is defined }}

        <div class="mb-3">
          <label for="email" class="form-label">E-mail</label>
          <input type="email" class="form-control" id="email" name="email"
                 value="{{ request.form.get('email','') }}" required autocomplete="username">
        </div>

        <div class="mb-2">
          <label for="password" class="form-label">Senha</label>
          <div class="input-group">
            <input type="password" class="form-control" id="password" name="password" required autocomplete="current-password">
            <button type="button" class="btn btn-outline-secondary" id="togglePwd" title="Mostrar/ocultar">
              <i class="bi bi-eye"></i>
            </button>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="1" id="remember" name="remember">
            <label class="form-check-label" for="remember">Manter conectado</label>
          </div>
          <div class="forgot">
            <a href="{{ url_for('auth.forgot_password', tenant_slug=tenant.slug) }}">Esqueceu a senha?</a>
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100 btn-login">Entrar</button>
      </form>

      {# üîî Sem bloco de mensagens local ‚Äî a banner superior vem do base.html #}

      {# Reenviar link de confirma√ß√£o #}
      <div class="mt-3 small" id="resend-block">
        N√£o recebeu o e-mail de confirma√ß√£o?
        <form id="resend-form"
              method="post"
              action="{{ url_for('auth.resend_confirmation', tenant_slug=tenant.slug) }}"
              class="d-inline align-baseline">
          {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
          <input type="hidden" name="email" id="resend-email">
          <button type="submit" class="btn btn-link btn-sm p-0 align-baseline" id="resend-btn">
            Reenviar link
          </button>
        </form>
        <span class="text-muted ms-2" id="resend-feedback"></span>
      </div>

      <div class="text-center mt-4 muted small">
        Ambiente: <strong>{{ tenant.name if tenant else '‚Äî' }}</strong>
      </div>
    </div>
  </section>

  {% if show_hero %}
  <section class="auth-right">
    <div class="hero-bg" style="
      {% if hero_img %}background-image:url('{{ hero_url }}');
      {% else %}background-image:linear-gradient(120deg,#0b1e3a,#112d58);
      {% endif %}"></div>
    <div class="hero-overlay"></div>
    <div class="hero-copy">
      <div class="hero-box">
        {% if hero_kicker %}<div class="hero-kicker">{{ hero_kicker }}</div>{% endif %}
        {% if hero_title  %}<h1 class="hero-title">{{ hero_title }}</h1>{% endif %}
        {% if hero_desc   %}<p class="hero-desc">{{ hero_desc }}</p>{% endif %}
      </div>
    </div>
  </section>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Mostrar/ocultar senha
  (function(){
    const btn = document.getElementById('togglePwd');
    const input = document.getElementById('password');
    if(btn && input){
      btn.addEventListener('click', function(){
        const isPwd = input.type === 'password';
        input.type = isPwd ? 'text' : 'password';
        this.innerHTML = isPwd ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
      });
    }
  })();

  // Reenviar confirma√ß√£o
  (function(){
    const loginEmail = document.getElementById('email');
    const hiddenEmail = document.getElementById('resend-email');
    const form = document.getElementById('resend-form');
    const btn = document.getElementById('resend-btn');
    const fb = document.getElementById('resend-feedback');
    if (!loginEmail || !hiddenEmail || !form) return;

    const sync = () => hiddenEmail.value = (loginEmail.value || '').trim();
    loginEmail.addEventListener('input', sync);
    sync();

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      sync();
      if (!hiddenEmail.value) { fb.textContent = 'Informe o e-mail acima e tente novamente.'; return; }
      btn.disabled = true; fb.textContent = 'Enviando...';
      try {
        const res = await fetch(form.action, { method:'POST', body:new FormData(form), headers:{'X-Requested-With':'fetch'} });
        const data = await res.json();
        fb.textContent = data.ok ? (data.already ? 'Este e-mail j√° est√° confirmado.' : 'Link reenviado. Confira sua caixa de entrada.') : (data.error || 'N√£o foi poss√≠vel reenviar agora.');
      } catch { fb.textContent = 'Falha de rede. Tente novamente.'; }
      finally { btn.disabled = false; }
    });
  })();
</script>
{% endblock %}
